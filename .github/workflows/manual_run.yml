name: Manual Run (Analyst Workbench)

on:
  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target Date (YYYY-MM-DD)'
        required: false
        default: ''
      model:
        description: 'Gemini Model'
        required: true
        default: 'gemini-3-flash-free'
      action:
        description: 'Action to perform (run, update-economy, update-company, input-news, inspect)'
        required: true
        default: 'update-economy'
      tickers:
        description: 'Comma-separated list of tickers (for update-company)'
        required: false
        default: ''
      text:
        description: 'News text (for input-news)'
        required: false
        default: ''
      news_url:
        description: 'URL to news text file'
        required: false
        default: ''

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        env:
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
          PYTHONPATH: .
        run: |
          pytest

      - name: Run Analyst Workbench
        env:
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
          # Pass inputs as env vars to handle special characters and spaces safely
          INPUT_DATE: ${{ github.event.inputs.target_date }}
          INPUT_MODEL: ${{ github.event.inputs.model }}
          INPUT_ACTION: ${{ github.event.inputs.action }}
          INPUT_TICKERS: ${{ github.event.inputs.tickers }}
          INPUT_TEXT: ${{ github.event.inputs.text }}
          INPUT_URL: ${{ github.event.inputs.news_url }}
        run: |
          DATE_ARG=""
          if [ "$INPUT_DATE" != "today" ] && [ "$INPUT_DATE" != "" ]; then
            DATE_ARG="--date $INPUT_DATE"
          fi

          TICKER_ARG=""
          if [ "$INPUT_TICKERS" != "" ]; then
            TICKER_ARG="--tickers $INPUT_TICKERS"
          fi
          
          # Prioritize URL over text if both are present
          if [ "$INPUT_URL" != "" ]; then
            python main.py --action "$INPUT_ACTION" $DATE_ARG --model "$INPUT_MODEL" --url "$INPUT_URL" $TICKER_ARG
          elif [ "$INPUT_TEXT" != "" ]; then
            python main.py --action "$INPUT_ACTION" $DATE_ARG --model "$INPUT_MODEL" --text "$INPUT_TEXT" $TICKER_ARG
          else
            python main.py --action "$INPUT_ACTION" $DATE_ARG --model "$INPUT_MODEL" $TICKER_ARG
          fi
